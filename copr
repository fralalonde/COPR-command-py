#!/usr/bin/env python3
import sys
import subprocess
import os
import urllib.request
from pathlib import Path

REPO_DIR = Path("/etc/yum.repos.d")
BACKUP_DIR = Path.home() / "COPR"

HELP_TEXT = r"""
====== Experimental COPR Command in non-DNF Fedora Distributions ======

Usage: copr [enable|disable|remove|list|search|help] [repo or author/repo]

Examples:
  copr enable kdesig/kde-nightly-qt6
  copr remove _copr_patrickl-wine-tkg
  copr remove patrickl-wine-tkg
  copr remove bazzite-org/bazzite
"""

WARNING_QUESTION = """
Enabling a Copr repository.

Do you really want to enable copr.fedorainfracloud.org/{author}/{repo}? [y/N]:
"""

def run0(*cmd):
    return subprocess.run(["run0", *cmd], check=False)

def die(msg):
    print(msg)
    sys.exit(1)

def secure_files():
    print("Securing repo files...")
    rc = run0("sh", "-c",
              "chown root:root /etc/yum.repos.d/* && "
              "chmod 744 /etc/yum.repos.d/* && "
              "chcon -R system_u:object_r:system_conf_t:s0 /etc/yum.repos.d/")
    if rc.returncode != 0:
        die("Failed to secure repo files!")

def backup_and_remove(path: Path):
    BACKUP_DIR.mkdir(parents=True, exist_ok=True)
    dest = BACKUP_DIR / path.name
    rc = run0("sh", "-c",
              f"mv '{path}' '{dest}' && chown '{os.environ['USER']}' '{dest}'")
    if rc.returncode == 0:
        print(f"Removed and backed up: {path.name}")
    else:
        die("Failed to remove repository.")

def get_releasever():
    return subprocess.check_output(["rpm", "-E", "%fedora"], text=True).strip()

# ------------------------------------------------------------
# ENABLE
# ------------------------------------------------------------
def cmd_enable(author, repo):
    ans = input(WARNING_QUESTION.format(author=author, repo=repo)).strip().lower()
    if ans not in ("y", "yes"):
        print("Cancelled.")
        return

    fname = REPO_DIR / f"_copr_{author}-{repo}.repo"
    if fname.exists():
        run0("sed", "-i", "s/enabled=0/enabled=1/g", str(fname))
        print("Repository enabled.")
        return

    rel = get_releasever()
    url = f"https://copr.fedorainfracloud.org/coprs/{author}/{repo}/repo/fedora-{rel}/{author}-{repo}-fedora.repo"
    print("Downloading:", url)

    try:
        content = urllib.request.urlopen(url).read()
    except Exception as e:
        die(f"Download failed: {e}")

    # write file via run0 tee (for root)
    p = subprocess.Popen(["run0", "tee", str(fname)], stdin=subprocess.PIPE)
    p.communicate(content)
    if p.returncode != 0:
        die("Failed to install repo file.")

    secure_files()

# ------------------------------------------------------------
# DISABLE
# ------------------------------------------------------------
def cmd_disable(author, repo):
    fname = REPO_DIR / f"_copr_{author}-{repo}.repo"
    if not fname.exists():
        die("Repo not found.")
    run0("sed", "-i", "s/enabled=1/enabled=0/g", str(fname))
    print("Repository disabled.")

# ------------------------------------------------------------
# REMOVE
# ------------------------------------------------------------

def find_repo_files(query: str):
    """Return matching repo files by filename OR content."""
    query_lower = query.lower()
    matches = []

    for path in REPO_DIR.glob("*.repo"):
        # check filename
        if query_lower in path.name.lower():
            matches.append(path)
            continue
        # fallback: check content
        try:
            if query_lower in path.read_text().lower():
                matches.append(path)
        except Exception:
            pass

    return matches

def cmd_remove(author, repo_name):
    # CASE 1: author/repo format
    if author:
        path = REPO_DIR / f"_copr_{author}-{repo_name}.repo"
        if path.exists():
            backup_and_remove(path)
            return

    # CASE 2: raw repo name or filename-like name
    matches = find_repo_files(repo_name)

    if not matches:
        die(f"No repositories matching '{repo_name}' found.")

    if len(matches) == 1:
        path = matches[0]
        ans = input(f"Remove '{path.name}'? (y/N): ").strip().lower()
        if ans == "y":
            backup_and_remove(path)
        else:
            print("Cancelled.")
        return

    print("Multiple matches found:")
    for i, m in enumerate(matches):
        print(f"  {i+1}) {m.name}")

    sel = input("Choose number to remove (or N to cancel): ").strip().lower()
    if not sel.isdigit():
        print("Cancelled.")
        return

    idx = int(sel) - 1
    if idx < 0 or idx >= len(matches):
        print("Invalid selection.")
        return

    backup_and_remove(matches[idx])

# ------------------------------------------------------------
# LIST
# ------------------------------------------------------------
def cmd_list():
    for p in REPO_DIR.glob("*.repo"):
        print(p.stem)

# ------------------------------------------------------------
# SEARCH
# ------------------------------------------------------------
def cmd_search(term):
    url = f"https://copr.fedorainfracloud.org/coprs/fulltext/?fulltext={term}"
    subprocess.Popen(["xdg-open", url])

# ------------------------------------------------------------
# MAIN
# ------------------------------------------------------------
def main():
    if len(sys.argv) < 2:
        print(HELP_TEXT)
        return

    cmd = sys.argv[1]

    if cmd in ("help", "-h", "--help"):
        print(HELP_TEXT)
        return

    if cmd == "list":
        cmd_list()
        return

    if len(sys.argv) < 3:
        print(HELP_TEXT)
        return

    arg = sys.argv[2]

    if "/" in arg:
        author, repo = arg.split("/", 1)
    else:
        author, repo = None, arg

    if cmd == "enable":
        if not author:
            die("enable requires author/repo")
        cmd_enable(author, repo)

    elif cmd == "disable":
        if not author:
            die("disable requires author/repo")
        cmd_disable(author, repo)

    elif cmd == "remove":
        cmd_remove(author, repo)

    elif cmd == "search":
        cmd_search(arg)

    else:
        print(HELP_TEXT)

if __name__ == "__main__":
    main()
