#!/usr/bin/env python3
import sys
import subprocess
import shutil
import os
from pathlib import Path
import urllib.request

# ----- constants -----

HELP_TEXT = r"""
====== Experimental COPR Command in non-DNF Fedora Distributions ======

This Tool is not made or supported by the Fedora Project,
but aims to reproduce the "dnf copr" functionalities for easily adding COPRs.

Usage: copr [OPTION] [ARGUMENT]

Options:
  enable    Add COPR repository
  disable   Keep a repo but disable it
  remove    Remove COPR repository after backing it up
  list      List all COPR repositories in your repo folder
  search    Search for a COPR repository by name (in your Browser)
  help      Display this help text

Argument:
  Name of the COPR repository (for search) or "author/repo" (for install and remove)

Examples:
  copr enable kdesig/kde-nightly-qt6
  copr remove kdesig/kde-nightly-qt6
  copr list
  copr search bubblejail
"""

WARNING_QUESTION = """
Enabling a Copr repository. Please note that this repository is not part
of the main distribution, and quality may vary.

The Fedora Project does not exercise any power over the contents of
this repository beyond the rules outlined in the Copr FAQ at
<https://docs.pagure.org/copr.copr/user_documentation.html#what-i-can-build-in-copr>,
and packages are not held to any quality or security level.

Please do not file bug reports about these packages in Fedora
Bugzilla. In case of problems, contact the owner of this repository.

Do you really want to enable copr.fedorainfracloud.org/{author}/{repo}? [y/N]:
"""

REPO_DIR = Path("/etc/yum.repos.d")
BACKUP_DIR = Path.home() / "COPR"


# ----- helpers -----

def run0(*cmd):
    """Wrapper for run0-like privileged commands."""
    return subprocess.run(["run0", *cmd], check=False)


def die(msg):
    print(msg)
    sys.exit(1)


def secure_files():
    print("Securing the repo files against manipulation. Please enter your password one last time.")
    rc = run0("sh", "-c",
              "chown root:root /etc/yum.repos.d/* && "
              "chmod 744 /etc/yum.repos.d/* && "
              "chcon -R system_u:object_r:system_conf_t:s0 /etc/yum.repos.d/")
    if rc.returncode != 0:
        die("Failed to secure the repo files!")


def backup_and_remove(repo_file: Path, author: str, repo: str):
    BACKUP_DIR.mkdir(parents=True, exist_ok=True)
    backup_path = BACKUP_DIR / f"_copr_{author}-{repo}.repo"

    rc = run0("sh", "-c",
              f"mv '{repo_file}' '{backup_path}' && "
              f"chown '{os.environ['USER']}' '{backup_path}'")
    if rc.returncode == 0:
        print(f"COPR Repository '{repo}' removed.")
    else:
        print("ERROR removing COPR repository.")


def get_releasever():
    # rpm -E %fedora
    return subprocess.check_output(["rpm", "-E", "%fedora"], text=True).strip()


# ----- commands -----

def cmd_enable(author, repo):
    q = WARNING_QUESTION.format(author=author, repo=repo)
    ans = input(q).strip().lower()
    if ans not in ("y", "yes"):
        print("Unknown option, exiting.")
        return

    fname = REPO_DIR / f"_copr_{author}-{repo}.repo"

    if fname.exists():
        run0("sed", "-i", "s/enabled=0/enabled=1/g", str(fname))
        print(f"Repository {author}/{repo} enabled")
        return

    release = get_releasever()
    url = f"https://copr.fedorainfracloud.org/coprs/{author}/{repo}/repo/fedora-{release}/{author}-{repo}-fedora.repo"

    print(f"downloading repo '{repo}' from '{author}' for Fedora '{release}'...")
    try:
        with urllib.request.urlopen(url) as resp:
            content = resp.read()
    except Exception:
        die(f"Could not download repo file from {url}")

    tmp = Path("/tmp") / f"{author}-{repo}.repo"
    tmp.write_bytes(content)

    run0("tee", str(fname), input=content)
    secure_files()


def cmd_disable(author, repo):
    fname = REPO_DIR / f"_copr_{author}-{repo}.repo"
    if not fname.exists():
        die("Already disabled or repo not found.")
    subprocess.run(["sed", "-i", "s/enabled=1/enabled=0/g", str(fname)])
    print(f"Repository {author}/{repo} disabled.")


def cmd_remove(author, repo):
    fname = REPO_DIR / f"_copr_{author}-{repo}.repo"

    if fname.exists():
        backup_and_remove(fname, author, repo)
        return

    # fallback: search by repo name
    print(f"Repo '{author}/{repo}' not found, trying a search...")
    matches = [p for p in REPO_DIR.glob("*.repo") if repo in p.read_text()]

    if not matches:
        die(f'No repositories containing "{repo}" were found.')

    match = matches[0]
    ans = input(f'Repo "{match}" was found. Do you want to backup and remove this repo? (y/N) ').strip().lower()
    if ans == "y":
        backup_and_remove(match, author, repo)
    else:
        sys.exit(1)


def cmd_list():
    for p in REPO_DIR.glob("_copr*.repo"):
        print(p.name.replace("_copr_", "").replace(".repo", ""))


def cmd_search(term):
    url = f"https://copr.fedorainfracloud.org/coprs/fulltext/?fulltext={term}"
    subprocess.Popen(["xdg-open", url])


# ----- main -----

def main():
    if len(sys.argv) < 2:
        print(HELP_TEXT)
        return

    action = sys.argv[1]

    if action in ("help", "-h", "--help", "-help", "--h"):
        print(HELP_TEXT)
        return

    if action == "list":
        cmd_list()
        return

    # everything else requires a second arg
    if len(sys.argv) < 3:
        print(HELP_TEXT)
        return

    arg = sys.argv[2]
    if "/" in arg:
        author, repo = arg.split("/", 1)
    else:
        author, repo = None, None

    if action == "enable":
        if not author or not repo:
            die("Format must be author/repo")
        cmd_enable(author, repo)
    elif action == "disable":
        if not author or not repo:
            die("Format must be author/repo")
        cmd_disable(author, repo)
    elif action == "remove":
        if not author or not repo:
            die("Format must be author/repo")
        cmd_remove(author, repo)
    elif action == "search":
        cmd_search(arg)
    else:
        print(HELP_TEXT)


if __name__ == "__main__":
    main()
